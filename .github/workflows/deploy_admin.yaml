name: 'Deploy admin'

on:
  push:
    branches:
      # - 'main'
      - 'feature/turborepo-migration'
    paths:
      - 'apps/admin-next/**'
      - 'packages/**'

env:
  VERCEL_TOKEN: '${{ secrets.VERCEL_TOKEN }}'
  VERCEL_ADMIN_APP_NAME: '${{ secrets.VERCEL_ADMIN_APP_NAME }}'
  VERCEL_ADMIN_ORGANIZATION_ID: '${{ secrets.VERCEL_ADMIN_ORGANIZATION_ID }}'
  VERCEL_ADMIN_PROJECT_ID: '${{ secrets.VERCEL_ADMIN_PROJECT_ID }}'

  DATABASE_URL: '${{ secrets.DATABASE_URL }}'
  PAYLOAD_SECRET: '${{ secrets.PAYLOAD_SECRET }}'
  BACKEND_URL: '${{ secrets.BACKEND_URL }}'
  NEXT_PUBLIC_BACKEND_URL: '${{ secrets.BACKEND_URL }}'
  AUTH_TOKEN: '${{ secrets.AUTH_TOKEN }}'
  NEXT_PUBLIC_AUTH_TOKEN: '${{ secrets.AUTH_TOKEN }}'

jobs:
  Deploy:
    runs-on: 'ubuntu-latest'

    steps:
      - uses: 'actions/checkout@v3'
      - uses: 'actions/setup-node@v3'
        with:
          node-version: 18
      - name: 'Setup environment'
        run: 'chmod +x scripts/pipeline/setup_environment.sh && scripts/pipeline/setup_environment.sh'
      - name: 'Set environment variables'
        uses: 'dkershner6/vercel-set-env-action@v3'
        with:
          token: '${{ env.VERCEL_TOKEN }}'
          projectName: '${{ env.VERCEL_ADMIN_APP_NAME }}'
          envVariableKeys: '${{ env.ADMIN_ENV_VARIABLES }}'
#      - name: 'Move vercel.json file'
#        run: 'mv admin/vercel.json vercel.json'
      - name: 'Move vercel.json file'
        run: 'mv apps/admin-next/vercel.json vercel.json'
#      - name: 'Install dependencies'
#        run: 'npm install'
#      - name: 'Build'
#        run: 'npm run build:admin'
#      - name: 'Move admin entrypoint'
#        run: 'mv apps/admin-express/api api'
      - name: 'Deploy'
        uses: 'amondnet/vercel-action@v20'
        with:
          vercel-token: '${{ env.VERCEL_TOKEN }}'
          vercel-args: '--prod --yes'
          vercel-org-id: '${{ env.VERCEL_ADMIN_ORGANIZATION_ID }}'
          vercel-project-id: '${{ env.VERCEL_ADMIN_PROJECT_ID }}'
      - name: 'Get deploy info'
        id: 'build-state'
        uses: 'justincase-jp/vercel-preview-url-alias@0.2.1'
        with:
          vercel_access_token: '${{ env.VERCEL_TOKEN }}'
          vercel_project_id: '${{ env.VERCEL_ADMIN_PROJECT_ID }}'
      - name: 'Check build status'
        run: '[[ ${{ steps.build-state.outputs.status }} == "READY" ]] && echo Success build! || exit 1'
